<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Â≠¶Ê±âÂ≠ó</title>
    
    <!-- PWA Configuration -->
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-title" content="Â≠¶Ê±âÂ≠ó">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#FFB7C5">

    <!-- Icons -->
    <link rel="icon" type="image/svg+xml" href="icon.svg" />
    <link rel="apple-touch-icon" href="icon.svg" />
    
    <!-- REQUIRED SCRIPT ORDER -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Hanzi Writer -->
    <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>
    
    <!-- CnChar Core + Plugins (Order Matters) -->
    <script src="https://cdn.jsdelivr.net/npm/cnchar/cnchar.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cnchar-poly/cnchar.poly.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cnchar-order/cnchar.order.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cnchar-trad/cnchar.trad.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cnchar-radical/cnchar.radical.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cnchar-words/cnchar.words.min.js"></script>

    <!-- Configure Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'qy-pink': '#FFB7C5',      
                        'qy-dark-pink': '#FF8FAB', 
                        'qy-text-pink': '#D63384',
                        'qy-purple': '#E0BBE4',
                        'qy-dark-purple': '#957DAD',
                        'qy-text-purple': '#6D28D9',
                        'qy-bg-purple': '#F3E8FF',
                    },
                    fontFamily: {
                        'rounded': ['"Varela Round"', 'sans-serif'],
                        'chinese': ['"Ma Shan Zheng"', '"KaiTi"', 'serif'],
                    },
                    animation: {
                        'float': 'float 3s ease-in-out infinite',
                        'pop': 'bounce-in 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55)',
                        'dash': 'dash 1.5s ease-in-out forwards',
                        'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
                        'coin-bounce': 'coin-bounce 1s infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        'bounce-in': {
                            '0%': { transform: 'scale(0.3)', opacity: '0' },
                            '50%': { transform: 'scale(1.05)' },
                            '70%': { transform: 'scale(0.9)' },
                            '100%': { transform: 'scale(1)', opacity: '1' },
                        },
                        shake: {
                            '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' },
                            '20%, 80%': { transform: 'translate3d(2px, 0, 0)' },
                            '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' },
                            '40%, 60%': { transform: 'translate3d(4px, 0, 0)' }
                        },
                        'coin-bounce': {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-15px)' },
                        }
                    }
                }
            }
        }
    </script>
    
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Varela+Round&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Varela Round', "Microsoft YaHei", sans-serif;
            transition: background-color 0.5s ease;
            overscroll-behavior-y: none;
            touch-action: pan-y; 
        }
        .stroke-scroll::-webkit-scrollbar { height: 8px; }
        .stroke-scroll::-webkit-scrollbar-track { background: transparent; }
        .stroke-scroll::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 10px; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        @keyframes dog-jump { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-25px); } }
        .animate-dog-jump { animation: dog-jump 0.5s ease-in-out; }
        @keyframes dog-wiggle { 0%, 100% { transform: rotate(-10deg); } 50% { transform: rotate(10deg); } }
        .animate-dog-wiggle { animation: dog-wiggle 0.5s ease-in-out infinite; }
        @keyframes dog-spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .animate-dog-spin { animation: dog-spin 0.6s linear; }
        @keyframes dog-pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
        .animate-dog-pulse { animation: dog-pulse 1s ease-in-out infinite; }
        @keyframes tada { 0% { transform: scale(1); } 10%, 20% { transform: scale(0.9) rotate(-3deg); } 30%, 50%, 70%, 90% { transform: scale(1.1) rotate(3deg); } 40%, 60%, 80% { transform: scale(1.1) rotate(-3deg); } 100% { transform: scale(1) rotate(0); } }
        .animate-tada { animation: tada 1s ease-in-out; }

        /* Custom Background Patterns */
        .bg-pattern-hanzi {
            background-color: #fff1f2;
            background-image: url("data:image/svg+xml,%3Csvg width='24' height='24' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M12 24c6.627 0 12-5.373 12-12S18.627 0 12 0 0 5.373 0 12s5.373 12 12 12zm0-2c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z' fill='%23fecdd3' fill-opacity='0.25' fill-rule='evenodd'/%3E%3C/svg%3E");
        }

        .bg-pattern-english {
            background-color: #faf5ff;
            background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23e9d5ff' fill-opacity='0.4' fill-rule='evenodd'%3E%3Cpath d='M0 40L40 0H20l-20 20M40 40V20L20 40'/%3E%3C/g%3E%3C/svg%3E");
        }
    </style>
</head>
<body class="bg-pattern-hanzi">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Data Constants ---
        const GRADE_CHARS = {
            "1-2": "‰∏Ä‰∫å‰∏âÂõõ‰∫îÂÖ≠‰∏ÉÂÖ´‰πùÂçÅÁôæÂçÉ‰∏á‰∏ä‰∏≠‰∏ãÂ∑¶Âè≥ÂâçÂêéÂ§ßÂ∞èÂ§öÂ∞ëÈïøÁü≠È´òÁüÆÊó•ÊúàÊ∞¥ÁÅ´ÂúüÊú®ÈáëÂ§©È£éÈõ®Èõ™Áîµ‰∫ëÂ±±Áü≥Áî∞Âè£ËÄ≥ÁõÆÊâãË∂≥Ë∫´ÂøÉ‰∫∫Áà∂ÊØçÂÑøÂ•≥ÂÖÑÂºüÂßêÂ¶πÂ∏àÁîüÂèãÁà±ÁúãÂê¨ËØ¥ËØªÂÜôÁîªÂî±Ë∑≥Ë∑ëÂùêÁ´ãËµ∞È£ûÂêÉÂñùÁé©‰πêÊó©ÊôöÂçàÂè§‰ªäÊòéÁ∫¢ÈªÑËìùÁªøÁôΩÈªëÂºÄÂÖ≥Èó≠Âá∫ÂÖ•Êù•ÂéªÊúâÊó†Â§öÈöæÁÇπÊñπÂúÜ",
            "3-4": "Êò•Â§èÁßãÂÜ¨‰∏úÂçóË•øÂåóÊ±üÊ≤≥ÊπñÊµ∑Ê£ÆÊûóËçâÂéüÊ≤ôÊº†È´òÂéüÂüé‰π°Ë°óÈÅìÂ∑•ÂéÇÂïÜÂ∫óÂåªÈô¢Â≠¶Ê†°ÊïôÂÆ§Âõæ‰π¶È¶ÜÊìçÂú∫ÂÖ¨Âõ≠Âä®Áâ©Âõ≠Ê§çÁâ©Âõ≠È£ûÊú∫ÁÅ´ËΩ¶Ê±ΩËΩ¶ËΩÆËàπËá™Ë°åËΩ¶‰∫§ÈÄö‰ø°Âè∑ËßÑÂàôÂÆâÂÖ®Ë≠¶ÂØüÂåªÁîüÊä§Â£´Â∑•‰∫∫ÂÜúÊ∞ëËß£ÊîæÂÜõÁßëÂ≠¶ÂÆ∂ÂèëÊòéÂàõÈÄ†Êô∫ÊÖßÂãáÊï¢ËØöÂÆûÂÆà‰ø°Âõ¢Áªì‰∫íÂä©",
            "5-6": "ÂÆáÂÆô‰∏ñÁïåÂõΩÂÆ∂Ê∞ëÊóèÂéÜÂè≤ÊñáÂåñ‰º†ÁªüËäÇÊó•È£é‰øó‰π†ÊÉØËØóËØçÊ≠åËµãÁ•ûËØù‰º†ËØ¥ÂØìË®ÄÊïÖ‰∫ãÊàêËØ≠Ë∞öËØ≠Ê†ºË®ÄË≠¶Âè•ÈòÖËØªÂÜô‰ΩúÊºîËÆ≤Ëæ©ËÆ∫ËßÇÂØüÊÄùËÄÉÊÉ≥Ë±°Êé¢Á¥¢ÂÆûÈ™åÁ†îÁ©∂ÂàÜÊûêÁªºÂêàÊØîËæÉÂΩíÁ∫≥ÊÄªÁªìËÆ°ÂàíÁªÑÁªáÈ¢ÜÂØºÁÆ°ÁêÜÂêà‰ΩúÁ´û‰∫âÂÖ¨Âπ≥Ê≠£‰πâÊ≥ïÂæãÈÅìÂæ∑Ë¥£‰ªª‰πâÂä°ÁêÜÊÉ≥‰ø°ÂøµËøΩÊ±ÇÂçìË∂ä"
        };
        const COMMON_CHARS = GRADE_CHARS["1-2"] + GRADE_CHARS["3-4"] + GRADE_CHARS["5-6"];

        const PINYIN_INITIALS = ['Êó†','b','p','m','f','d','t','n','l','g','k','h','j','q','x','zh','ch','sh','r','z','c','s','y','w'];
        const PINYIN_MEDIALS = ['','i','u','v'];
        const PINYIN_FINALS = ['a','o','e','ai','ei','ao','ou','an','en','ang','eng','ong','i','ia','ie','iao','iu','ian','in','iang','ing','iong','u','ua','uo','ui','uai','uan','un','uang','v','ve','vn'];

        const SHOP_ITEMS = [
            { id: 'default', category: 'skin', name: 'ÈªòËÆ§Â∞èÁãó', emoji: 'üê∂', price: 0 },
            { id: 'cat', category: 'skin', name: 'Â∞èÁå´Âí™', emoji: 'üê±', price: 200 },
            { id: 'rabbit', category: 'skin', name: 'Â∞èÁôΩÂÖî', emoji: 'üê∞', price: 250 },
            { id: 'fox', category: 'skin', name: 'Â∞èÁãêÁã∏', emoji: 'ü¶ä', price: 300 },
            { id: 'pig', category: 'skin', name: 'Â∞èÁå™Áå™', emoji: 'üê∑', price: 300 },
            { id: 'tiger', category: 'skin', name: 'Â∞èËÄÅËôé', emoji: 'üêØ', price: 400 },
            { id: 'panda', category: 'skin', name: 'Â§ßÁÜäÁå´', emoji: 'üêº', price: 450 },
            { id: 'dragon', category: 'skin', name: '‰∏≠ÂõΩÈæô', emoji: 'üê≤', price: 500 },
            { id: 'hat', category: 'accessory', slot: 'head', name: 'È≠îÊúØÂ∏Ω', emoji: 'üé©', price: 100 },
            { id: 'grad_cap', category: 'accessory', slot: 'head', name: 'ÂçöÂ£´Â∏Ω', emoji: 'üéì', price: 150 },
            { id: 'crown', category: 'accessory', slot: 'head', name: 'ÁöáÂÜ†', emoji: 'üëë', price: 200 },
            { id: 'headphones', category: 'accessory', slot: 'head', name: 'ËÄ≥Êú∫', emoji: 'üéß', price: 120 },
            { id: 'glasses', category: 'accessory', slot: 'eyes', name: 'Â¢®Èïú', emoji: 'üï∂Ô∏è', price: 50 },
            { id: 'nerd_glasses', category: 'accessory', slot: 'eyes', name: 'Â≠¶Èú∏ÁúºÈïú', emoji: 'üëì', price: 60 },
            { id: 'tie', category: 'accessory', slot: 'neck', name: 'È¢ÜÂ∏¶', emoji: 'üëî', price: 60 },
            { id: 'scarf', category: 'accessory', slot: 'neck', name: 'Âõ¥Â∑æ', emoji: 'üß£', price: 80 },
            { id: 'medal', category: 'accessory', slot: 'neck', name: 'Â•ñÁâå', emoji: 'ü•á', price: 200 },
        ];

        const PET_DIALOGUES = {
            default: { cn: ["‰πî‰æùÂä†Ê≤πÔºÅ", "ÊàëÊòØ‰Ω†ÁöÑÂ•ΩÊúãÂèãÔºÅ", "‰ªäÂ§©‰πüË¶ÅÂä™ÂäõÂì¶ÔºÅ"], en: ["Keep going!", "I'm your friend!", "Study hard!"] },
            cat: { cn: ["Âñµ~ ËÆ§ÁúüÂÜôÂ≠óÔºÅ", "‰ºòÈõÖÂú∞Â≠¶‰π†„ÄÇ", "Â∞èÈ±ºÂπ≤Âú®Âì™ÈáåÔºü"], en: ["Meow~ Write carefully!", "Learn gracefully.", "Where is my fish?"] },
            // ... (Other dialogues can be kept simple or expanded)
        };

        const PHONICS_DATA = [
            { id: 'A', word: 'Apple', meaning: 'ËãπÊûú', emoji: 'üçé', vocab: [{en: 'Ant', cn: 'ËöÇËöÅ'}, {en: 'Arm', cn: 'ÊâãËáÇ'}, {en: 'Art', cn: 'Ëâ∫ÊúØ'}] },
            { id: 'B', word: 'Bear', meaning: 'Â∞èÁÜä', emoji: 'üêª', vocab: [{en: 'Ball', cn: 'ÁêÉ'}, {en: 'Bird', cn: 'È∏ü'}, {en: 'Book', cn: '‰π¶'}] },
            { id: 'C', word: 'Cat', meaning: 'Â∞èÁå´', emoji: 'üê±', vocab: [{en: 'Car', cn: 'Ê±ΩËΩ¶'}, {en: 'Cup', cn: 'ÊùØÂ≠ê'}, {en: 'Cake', cn: 'ËõãÁ≥ï'}] },
            { id: 'D', word: 'Dog', meaning: 'Â∞èÁãó', emoji: 'üê∂', vocab: [{en: 'Duck', cn: 'È∏≠Â≠ê'}, {en: 'Door', cn: 'Èó®'}, {en: 'Desk', cn: '‰π¶Ê°å'}] },
            { id: 'E', word: 'Egg', meaning: 'È∏°Ëõã', emoji: 'ü•ö', vocab: [{en: 'Elephant', cn: 'Â§ßË±°'}, {en: 'Ear', cn: 'ËÄ≥Êúµ'}, {en: 'Eye', cn: 'ÁúºÁùõ'}] },
            { id: 'F', word: 'Fish', meaning: 'Â∞èÈ±º', emoji: 'üêü', vocab: [{en: 'Frog', cn: 'ÈùíËõô'}, {en: 'Fan', cn: 'È£éÊâá'}, {en: 'Foot', cn: 'ËÑö'}] },
            { id: 'G', word: 'Girl', meaning: 'Â•≥Â≠©', emoji: 'üëß', vocab: [{en: 'Goat', cn: 'Â±±Áæä'}, {en: 'Grass', cn: 'Ëçâ'}, {en: 'Green', cn: 'ÁªøËâ≤'}] },
            { id: 'H', word: 'Happy', meaning: 'ÂºÄÂøÉ', emoji: 'üòÑ', vocab: [{en: 'Hat', cn: 'Â∏ΩÂ≠ê'}, {en: 'Hand', cn: 'Êâã'}, {en: 'House', cn: 'ÊàøÂ≠ê'}] },
            { id: 'I', word: 'Ice', meaning: 'ÂÜ∞Âùó', emoji: 'üßä', vocab: [{en: 'Ink', cn: 'Â¢®Ê∞¥'}, {en: 'Insect', cn: 'ÊòÜËô´'}, {en: 'Island', cn: 'Â≤õÂ±ø'}] },
            { id: 'J', word: 'Juice', meaning: 'ÊûúÊ±Å', emoji: 'üßÉ', vocab: [{en: 'Jelly', cn: 'ÊûúÂÜª'}, {en: 'Jump', cn: 'Ë∑≥'}, {en: 'Jar', cn: 'ÁΩêÂ≠ê'}] },
            { id: 'K', word: 'Kite', meaning: 'È£éÁ≠ù', emoji: 'ü™Å', vocab: [{en: 'Key', cn: 'Èí•Âåô'}, {en: 'King', cn: 'ÂõΩÁéã'}, {en: 'Kangaroo', cn: 'Ë¢ãÈº†'}] },
            { id: 'L', word: 'Lion', meaning: 'ÁãÆÂ≠ê', emoji: 'ü¶Å', vocab: [{en: 'Leaf', cn: 'Ê†ëÂè∂'}, {en: 'Leg', cn: 'ËÖø'}, {en: 'Lamp', cn: 'Âè∞ÁÅØ'}] },
            { id: 'M', word: 'Moon', meaning: 'Êúà‰∫Æ', emoji: 'üåô', vocab: [{en: 'Monkey', cn: 'Áå¥Â≠ê'}, {en: 'Milk', cn: 'ÁâõÂ•∂'}, {en: 'Map', cn: 'Âú∞Âõæ'}] },
            { id: 'N', word: 'Nose', meaning: 'ÈºªÂ≠ê', emoji: 'üëÉ', vocab: [{en: 'Net', cn: 'È∏üÂ∑¢'}, {en: 'Nurse', cn: 'Êä§Â£´'}, {en: 'Night', cn: 'Â§úÊôö'}] },
            { id: 'O', word: 'Orange', meaning: 'Ê©ôÂ≠ê', emoji: 'üçä', vocab: [{en: 'Octopus', cn: 'Á´†È±º'}, {en: 'Owl', cn: 'Áå´Â§¥Èπ∞'}, {en: 'Onion', cn: 'Ê¥ãËë±'}] },
            { id: 'P', word: 'Pig', meaning: 'Â∞èÁå™', emoji: 'üê∑', vocab: [{en: 'Pen', cn: 'Èí¢Á¨î'}, {en: 'Pan', cn: 'Âπ≥Â∫ïÈîÖ'}, {en: 'Park', cn: 'ÂÖ¨Âõ≠'}] },
            { id: 'Q', word: 'Queen', meaning: 'Â•≥Áéã', emoji: 'üë∏', vocab: [{en: 'Quilt', cn: 'Ë¢´Â≠ê'}, {en: 'Question', cn: 'ÈóÆÈ¢ò'}, {en: 'Quiet', cn: 'ÂÆâÈùô'}] },
            { id: 'R', word: 'Rabbit', meaning: 'ÂÖîÂ≠ê', emoji: 'üê∞', vocab: [{en: 'Red', cn: 'Á∫¢Ëâ≤'}, {en: 'Rose', cn: 'Áé´Áë∞'}, {en: 'Rain', cn: 'Èõ®'}] },
            { id: 'S', word: 'Sun', meaning: 'Â§™Èò≥', emoji: '‚òÄÔ∏è', vocab: [{en: 'Snake', cn: 'Ëõá'}, {en: 'Star', cn: 'ÊòüÊòü'}, {en: 'Sock', cn: 'Ë¢úÂ≠ê'}] },
            { id: 'T', word: 'Tiger', meaning: 'ËÄÅËôé', emoji: 'üêØ', vocab: [{en: 'Table', cn: 'Ê°åÂ≠ê'}, {en: 'Tree', cn: 'Ê†ë'}, {en: 'Ten', cn: 'ÂçÅ'}] },
            { id: 'U', word: 'Umbrella', meaning: 'Èõ®‰ºû', emoji: '‚òÇÔ∏è', vocab: [{en: 'Up', cn: 'Âêë‰∏ä'}, {en: 'Uncle', cn: 'ÂèîÂèî'}, {en: 'Under', cn: '‰∏ãÈù¢'}] },
            { id: 'V', word: 'Van', meaning: 'Ë¥ßËΩ¶', emoji: 'üöê', vocab: [{en: 'Violin', cn: 'Â∞èÊèêÁê¥'}, {en: 'Vest', cn: 'ËÉåÂøÉ'}, {en: 'Vegetable', cn: 'Ëî¨Ëèú'}] },
            { id: 'W', word: 'Water', meaning: 'Ê∞¥', emoji: 'üíß', vocab: [{en: 'Watch', cn: 'ÊâãË°®'}, {en: 'Wolf', cn: 'Áãº'}, {en: 'Wind', cn: 'È£é'}] },
            { id: 'X', word: 'Box', meaning: 'ÁõíÂ≠ê', emoji: 'üì¶', vocab: [{en: 'X-ray', cn: 'XÂÖâ'}, {en: 'Fox', cn: 'ÁãêÁã∏'}, {en: 'Six', cn: 'ÂÖ≠'}] },
            { id: 'Y', word: 'Yo-yo', meaning: 'Ê∫úÊ∫úÁêÉ', emoji: 'ü™Ä', vocab: [{en: 'Yellow', cn: 'ÈªÑËâ≤'}, {en: 'Yak', cn: 'Áâ¶Áâõ'}, {en: 'Year', cn: 'Âπ¥'}] },
            { id: 'Z', word: 'Zebra', meaning: 'ÊñëÈ©¨', emoji: 'ü¶ì', vocab: [{en: 'Zoo', cn: 'Âä®Áâ©Âõ≠'}, {en: 'Zero', cn: 'Èõ∂'}, {en: 'Zip', cn: 'ÊãâÈìæ'}] },
        ];

        // --- Improved Audio System ---
        const playAudio = (text, isEnglish = false) => {
            if (!window.speechSynthesis) return;
            
            // Ensure voices are loaded
            let voices = window.speechSynthesis.getVoices();
            if (voices.length === 0) {
                window.speechSynthesis.onvoiceschanged = () => {
                    voices = window.speechSynthesis.getVoices();
                    speak(text, isEnglish, voices);
                };
            } else {
                speak(text, isEnglish, voices);
            }
        };

        const speak = (text, isEnglish, voices) => {
            try {
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(text);
                
                // --- Voice Selection Logic ---
                // Try to find "Google US English" or "Google Chinese" or similar high-quality voices
                let preferredVoice = null;
                
                if (isEnglish) {
                    u.lang = 'en-US';
                    preferredVoice = voices.find(v => v.name.includes("Google US English")) || 
                                     voices.find(v => v.name.includes("Samantha")) || 
                                     voices.find(v => v.lang === 'en-US');
                } else {
                    u.lang = 'zh-CN';
                    preferredVoice = voices.find(v => v.name.includes("Google") && v.lang === 'zh-CN') || 
                                     voices.find(v => v.name.includes("Ting-Ting")) || 
                                     voices.find(v => v.lang === 'zh-CN');
                }

                if (preferredVoice) {
                    u.voice = preferredVoice;
                }

                // --- Professional Tuning ---
                u.rate = isEnglish ? 0.9 : 1.0; // Slightly slower for English learners
                u.pitch = 1.05; // Slightly higher pitch is often clearer for kids app
                u.volume = 1.0;

                window.speechSynthesis.speak(u);
            } catch (err) {
                console.warn("Speech error:", err);
            }
        };

        // --- Icons ---
        const ChineseKnotIcon = () => (
             <svg width="28" height="28" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg" className="drop-shadow-sm">
                <rect x="34" y="34" width="32" height="32" transform="rotate(45 50 50)" fill="#D32F2F" stroke="#B71C1C" strokeWidth="2" />
                <path d="M50 34 C50 20, 65 20, 65 35" stroke="#D32F2F" strokeWidth="4" fill="none" transform="rotate(-45 50 50)" />
                <path d="M50 34 C50 20, 35 20, 35 35" stroke="#D32F2F" strokeWidth="4" fill="none" transform="rotate(45 50 50)" />
                <path d="M50 66 C50 80, 65 80, 65 65" stroke="#D32F2F" strokeWidth="4" fill="none" transform="rotate(45 50 50)" />
                <path d="M50 66 C50 80, 35 80, 35 65" stroke="#D32F2F" strokeWidth="4" fill="none" transform="rotate(-45 50 50)" />
                <line x1="50" y1="74" x2="50" y2="95" stroke="#D32F2F" strokeWidth="4" strokeLinecap="round" />
                <rect x="42" y="42" width="16" height="16" transform="rotate(45 50 50)" fill="#FFCDD2" />
            </svg>
        );

        // --- Components ---

        const CheatKeypad = ({ onClose, onVerify }) => {
            const [input, setInput] = useState('');
            const handlePress = (num) => input.length < 9 && setInput(prev => prev + num);
            const handleDelete = () => setInput(prev => prev.slice(0, -1));
            const handleSubmit = () => {
                const pass = input.slice(0, 6);
                const amount = parseInt(input.slice(6), 10);
                if (pass === '830830' && amount) onVerify(amount); else { playAudio("ÂØÜÁ†ÅÈîôËØØ"); setInput(''); }
            };

            return (
                <div className="absolute inset-0 z-[500] bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 animate-pop">
                    <div className="bg-white rounded-[2rem] p-6 shadow-2xl w-full max-w-[320px] border-4 border-purple-100 flex flex-col gap-4">
                        <div className="flex justify-between items-center px-2">
                            <span className="font-bold text-gray-400 text-sm">SECRET CODE</span>
                            <button onClick={onClose} className="w-8 h-8 flex items-center justify-center bg-gray-100 rounded-full font-bold">‚úï</button>
                        </div>
                        <div className="bg-gray-100 h-20 rounded-2xl flex items-center justify-center px-4">
                             <span className="text-4xl font-mono font-bold text-gray-700 tracking-[0.2em]">{input || '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'}</span>
                        </div>
                        <div className="grid grid-cols-3 gap-3">
                            {[1,2,3,4,5,6,7,8,9].map(n => <button key={n} onClick={()=>handlePress(n.toString())} className="h-16 rounded-2xl bg-purple-50 text-2xl font-black text-qy-text-purple active:scale-95">{n}</button>)}
                            <button onClick={handleDelete} className="h-16 rounded-2xl bg-red-50 text-xl font-bold text-red-400">‚å´</button>
                            <button onClick={()=>handlePress('0')} className="h-16 rounded-2xl bg-purple-50 text-2xl font-black text-qy-text-purple">0</button>
                            <button onClick={handleSubmit} className="h-16 rounded-2xl bg-green-400 text-xl font-bold text-white">OK</button>
                        </div>
                    </div>
                </div>
            );
        };

        const ShopModal = ({ onClose, inventory, equippedSkin, equippedHead, equippedEyes, equippedNeck, balance, onBuy, onEquip, onAddPoints }) => {
            const [activeTab, setActiveTab] = useState('skin');
            const [showCheatPad, setShowCheatPad] = useState(false);
            
            const displayItems = SHOP_ITEMS.filter(item => {
                if(activeTab === 'skin') return item.category === 'skin';
                return item.slot === activeTab;
            });

            const isEquipped = (item) => {
                if (item.category === 'skin') return equippedSkin === item.id;
                if (item.slot === 'head') return equippedHead === item.id;
                if (item.slot === 'eyes') return equippedEyes === item.id;
                if (item.slot === 'neck') return equippedNeck === item.id;
                return false;
            };

            return (
                <div className="fixed inset-0 z-[400] bg-white/95 backdrop-blur-xl flex flex-col items-center animate-pop p-4">
                    {showCheatPad && <CheatKeypad onClose={() => setShowCheatPad(false)} onVerify={(a) => { onAddPoints(a); setShowCheatPad(false); alert(`Ëé∑Âæó ${a} ÈáëÂ∏Å!`); }} />}
                    <div className="w-full flex justify-between items-center mb-4">
                        <button onClick={onClose} className="bg-gray-100 p-2 rounded-full text-xl w-10 h-10 shadow-sm">‚úï</button>
                        <h2 className="text-2xl font-black text-qy-text-pink font-chinese">Â∞èÁãóÂïÜÂ∫ó</h2>
                        <div onClick={() => setShowCheatPad(true)} className="flex items-center bg-yellow-100 px-3 py-1 rounded-full border border-yellow-200 font-bold text-yellow-700">ü™ô {balance}</div>
                    </div>
                    <div className="flex gap-2 mb-4 bg-gray-100 p-1 rounded-xl w-full overflow-x-auto no-scrollbar">
                        {['skin', 'head', 'eyes', 'neck'].map(tab => (
                            <button key={tab} onClick={() => setActiveTab(tab)} className={`px-4 py-2 rounded-lg font-bold transition-all whitespace-nowrap ${activeTab === tab ? 'bg-white text-qy-text-pink shadow-sm' : 'text-gray-400'}`}>
                                {tab === 'skin' ? 'ÂÆ†Áâ©' : tab === 'head' ? 'Â§¥È•∞' : tab === 'eyes' ? 'ÁúºÈïú' : 'È¢àÈ•∞'}
                            </button>
                        ))}
                    </div>
                    <div className="flex-1 w-full overflow-y-auto px-1 pb-10 grid grid-cols-2 gap-4">
                        {displayItems.map(item => {
                            const owned = inventory.includes(item.id) || item.id === 'default';
                            const equipped = isEquipped(item);
                            return (
                                <div key={item.id} className={`bg-white rounded-2xl p-4 shadow-md border-2 flex flex-col items-center ${equipped ? 'border-green-400 bg-green-50' : 'border-pink-100'}`}>
                                    <div className="text-5xl mb-3">{item.emoji}</div>
                                    <h3 className="font-bold text-gray-700 mb-2">{item.name}</h3>
                                    <div className="text-xs text-gray-400 font-bold mb-3">{item.price > 0 ? `ü™ô ${item.price}` : 'ÂÖçË¥π'}</div>
                                    {owned ? 
                                        <button onClick={() => onEquip(item.category === 'accessory' && equipped ? {...item, unequip:true} : item)} className={`w-full py-2 rounded-xl font-bold ${equipped ? 'bg-gray-200 text-gray-500' : 'bg-green-500 text-white shadow-lg'}`}>{equipped ? 'Âç∏‰∏ã' : 'Á©øÊà¥'}</button> : 
                                        <button onClick={() => onBuy(item)} disabled={balance < item.price} className={`w-full py-2 rounded-xl font-bold ${balance < item.price ? 'bg-gray-200 text-gray-400' : 'bg-yellow-400 text-yellow-900 shadow-lg'}`}>Ë¥≠‰π∞</button>
                                    }
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const Mascot = ({ mode, status, skinId, headId, eyesId, neckId }) => {
            const [anim, setAnim] = useState('');
            const skinItem = SHOP_ITEMS.find(i => i.id === skinId) || SHOP_ITEMS[0];
            const headItem = SHOP_ITEMS.find(i => i.id === headId);
            const eyesItem = SHOP_ITEMS.find(i => i.id === eyesId);
            const neckItem = SHOP_ITEMS.find(i => i.id === neckId);

            useEffect(() => {
                if (status === 'success') setAnim('animate-tada'); 
                else if (status === 'sad') setAnim('animate-shake');
                else setAnim('');
            }, [status]);

            return (
                <div className={`relative w-20 h-20 flex items-center justify-center filter drop-shadow-lg transition-transform z-10 ${anim}`}>
                    <div className="text-6xl absolute z-10">{skinItem.emoji}</div>
                    {neckItem && <div className="absolute -bottom-2 z-20 text-3xl">{neckItem.emoji}</div>}
                    {eyesItem && <div className="absolute top-[35%] z-30 text-3xl opacity-90">{eyesItem.emoji}</div>}
                    {headItem && <div className="absolute -top-4 z-40 text-4xl">{headItem.emoji}</div>}
                </div>
            );
        };

        const HanziPlayer = ({ char, mode, onMistake, onCorrect, onComplete }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                if (!containerRef.current || !char) return;
                containerRef.current.innerHTML = "";
                const writer = HanziWriter.create(containerRef.current, char, {
                    width: 300, height: 300, padding: 20, showOutline: true,
                    strokeAnimationSpeed: 1, delayBetweenStrokes: 500,
                    radicalColor: '#D63384', strokeColor: '#333333', outlineColor: '#FFCCD5',
                    charDataLoader: (c, cb) => fetch(`https://cdn.jsdelivr.net/npm/hanzi-writer-data@2.0/${c}.json`).then(r=>r.json()).then(cb)
                });
                if(mode==='animate') writer.animateCharacter({ onComplete: () => setTimeout(()=>writer.animateCharacter(), 1000) });
                if(mode==='quiz') writer.quiz({ onMistake, onCorrectStroke: onCorrect, onComplete });
            }, [char, mode]);
            return (
                <div className="relative w-[300px] h-[300px]">
                    <svg className="absolute inset-0 w-full h-full" viewBox="0 0 300 300"><rect width="300" height="300" fill="white" rx="20"/><rect x="4" y="4" width="292" height="292" fill="none" stroke="#FFB7C5" strokeWidth="4" rx="20"/><line x1="0" y1="0" x2="300" y2="300" stroke="#FFCCD5" strokeWidth="2" strokeDasharray="8,8"/><line x1="300" y1="0" x2="0" y2="300" stroke="#FFCCD5" strokeWidth="2" strokeDasharray="8,8"/><line x1="150" y1="0" x2="150" y2="300" stroke="#FFCCD5" strokeWidth="2" strokeDasharray="8,8"/><line x1="0" y1="150" x2="300" y2="150" stroke="#FFCCD5" strokeWidth="2" strokeDasharray="8,8"/></svg>
                    <div ref={containerRef} className="relative z-10 w-full h-full cursor-pointer" />
                </div>
            );
        };

        const HanziQuiz = ({ onClose, setMascotStatus, addPoints }) => {
            const [gameState, setGameState] = useState('menu');
            const [level, setLevel] = useState('1-2');
            const [stage, setStage] = useState('read');
            const [questions, setQuestions] = useState([]);
            const [currentIdx, setCurrentIdx] = useState(0);
            const [score, setScore] = useState(0);
            const [strikes, setStrikes] = useState(0);
            const [earned, setEarned] = useState(0);

            const start = () => {
                const chars = (GRADE_CHARS[level] || GRADE_CHARS["1-2"]).split('');
                const qs = Array.from({length:5}, () => {
                    const char = chars[Math.floor(Math.random()*chars.length)];
                    const pinyin = cnchar.spell(char, 'tone').toLowerCase();
                    const opts = [pinyin];
                    while(opts.length<4) {
                        const r = cnchar.spell(chars[Math.floor(Math.random()*chars.length)],'tone').toLowerCase();
                        if(!opts.includes(r)) opts.push(r);
                    }
                    return { char, pinyin, opts: opts.sort(()=>Math.random()-0.5) };
                });
                setQuestions(qs);
                setGameState('playing');
                setCurrentIdx(0);
                setScore(0);
                setEarned(0);
                setStage('read');
                playAudio("ÊåëÊàòÂºÄÂßã", false);
            };

            const handleRead = (opt) => {
                if(opt === questions[currentIdx].pinyin) {
                    setScore(s=>s+1);
                    setEarned(e=>e+1);
                    addPoints(1);
                    setMascotStatus('success');
                    playAudio("ÂØπÂï¶ÔºåÂÜôÂÜôÁúã", false);
                    setStage('write');
                } else {
                    setMascotStatus('sad');
                    playAudio("‰∏çÂØπÂì¶", false);
                    setTimeout(next, 1000);
                }
            };

            const handleWriteMistake = () => {
                setStrikes(s=>s+1);
                playAudio("Âì¶Âô¢", false);
                if(strikes >= 2) setTimeout(next, 500);
            }

            const handleWriteComplete = () => {
                setEarned(e=>e+1);
                addPoints(1);
                setMascotStatus('success');
                playAudio("ÂÜôÂæóÁúüÊ£í", false);
                setTimeout(next, 1000);
            }

            const next = () => {
                setStrikes(0);
                setMascotStatus('idle');
                if(currentIdx < 4) {
                    setCurrentIdx(c=>c+1);
                    setStage('read');
                } else {
                    setGameState('result');
                    playAudio("ÊåëÊàòÁªìÊùü", false);
                }
            };

            return (
                <div className="fixed inset-0 z-[300] bg-white/95 backdrop-blur-xl flex flex-col items-center animate-pop p-4">
                    <button onClick={onClose} className="absolute top-4 left-4 bg-gray-100 p-2 rounded-full w-10 h-10">‚úï</button>
                    {gameState==='menu' ? (
                        <div className="mt-20 flex flex-col items-center gap-6 w-full max-w-sm">
                            <h2 className="text-3xl font-chinese text-qy-text-pink">Ê±âÂ≠óÊåëÊàò</h2>
                            <div className="flex gap-2">
                                {['1-2','3-4','5-6'].map(l=><button key={l} onClick={()=>setLevel(l)} className={`px-4 py-2 rounded-xl border-2 font-bold ${level===l?'bg-qy-pink text-white':'bg-white text-gray-400'}`}>{l}Âπ¥Á∫ß</button>)}
                            </div>
                            <div className="bg-blue-50 p-4 rounded-xl text-blue-600 text-sm">
                                <p>1. ÈÄâÂØπÊãºÈü≥ +1 ü™ô</p>
                                <p>2. ÂÜôÂØπÊ±âÂ≠ó +1 ü™ô</p>
                            </div>
                            <button onClick={start} className="w-full py-3 bg-yellow-400 text-yellow-900 rounded-xl font-black text-xl shadow-lg">ÂºÄÂßã</button>
                        </div>
                    ) : gameState==='result' ? (
                        <div className="mt-20 flex flex-col items-center gap-6">
                            <div className="text-8xl animate-tada">üèÜ</div>
                            <h2 className="text-3xl font-chinese">Ëé∑Âæó {earned} ÈáëÂ∏Å!</h2>
                            <button onClick={()=>setGameState('menu')} className="px-8 py-3 bg-qy-text-pink text-white rounded-full font-bold">ÂÜçÁé©‰∏ÄÊ¨°</button>
                        </div>
                    ) : (
                        <div className="mt-10 w-full max-w-sm flex flex-col items-center">
                            <div className="w-full bg-gray-100 h-2 rounded-full mb-8"><div className="bg-qy-pink h-full rounded-full transition-all" style={{width:`${(currentIdx+1)*20}%`}}></div></div>
                            {stage==='read' ? (
                                <>
                                    <div className="text-9xl font-chinese text-qy-text-pink mb-10">{questions[currentIdx].char}</div>
                                    <div className="grid grid-cols-2 gap-4 w-full">
                                        {questions[currentIdx].opts.map(o=><button key={o} onClick={()=>handleRead(o)} className="py-4 bg-white border-2 border-pink-100 rounded-xl text-xl font-bold shadow-sm active:scale-95">{o}</button>)}
                                    </div>
                                </>
                            ) : (
                                <div className="flex flex-col items-center">
                                    <p className="font-bold text-gray-400 mb-2">ËØ∑ÂÜôÂá∫: {questions[currentIdx].pinyin}</p>
                                    <div className="bg-white p-2 rounded-3xl border-4 border-pink-100 shadow-lg">
                                        <HanziPlayer key={questions[currentIdx].char} char={questions[currentIdx].char} mode="quiz" onMistake={handleWriteMistake} onCorrect={()=>{}} onComplete={handleWriteComplete} />
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        const EnglishView = ({ setMascotStatus, addPoints, skinId, headId, eyesId, neckId }) => {
            const [selectedItem, setSelectedItem] = useState(null);
            const [mode, setMode] = useState('learn'); // learn, quiz
            const [quizState, setQuizState] = useState({ q: [], idx: 0, score: 0, earned: 0, finished: false });

            const playPhonic = (item) => playAudio(`${item.id}... ${item.word}`, true);

            const startQuiz = () => {
                const qs = Array.from({length: 5}, () => {
                    const target = PHONICS_DATA[Math.floor(Math.random() * PHONICS_DATA.length)];
                    const type = Math.random() > 0.5 ? 'listen_find' : 'look_listen';
                    
                    // Generate Distractors
                    let distractors = [];
                    while(distractors.length < 2) {
                        const d = PHONICS_DATA[Math.floor(Math.random() * PHONICS_DATA.length)];
                        if (d.id !== target.id && !distractors.includes(d)) distractors.push(d);
                    }
                    const options = [target, ...distractors].sort(() => Math.random() - 0.5);
                    
                    return { target, type, options };
                });

                setQuizState({ q: qs, idx: 0, score: 0, earned: 0, finished: false });
                setMode('quiz');
                
                // If first question is listen type, play audio
                if(qs[0].type === 'listen_find') {
                    setTimeout(() => playAudio(qs[0].target.word, true), 800);
                }
            };

            const handleQuizOption = (opt) => {
                const currentQ = quizState.q[quizState.idx];
                
                // For "Look & Listen", clicking plays the sound. We need a way to submit. 
                // Simplified: Clicking IS submitting for kids.
                
                if (currentQ.type === 'look_listen') {
                    playAudio(opt.word, true); // Play the sound of the option clicked
                }

                if (opt.id === currentQ.target.id) {
                    setMascotStatus('success');
                    playAudio("Good job!", true);
                    setQuizState(prev => ({...prev, score: prev.score+1, earned: prev.earned+1}));
                    addPoints(1);
                    setTimeout(nextQ, 1000);
                } else {
                    setMascotStatus('sad');
                    playAudio("Try again", true);
                    // For listen_find, maybe play audio again?
                    if(currentQ.type === 'listen_find') setTimeout(()=>playAudio(currentQ.target.word, true), 1000);
                }
            };

            const nextQ = () => {
                setMascotStatus('idle');
                if (quizState.idx < 4) {
                    const nextIdx = quizState.idx + 1;
                    setQuizState(prev => ({...prev, idx: nextIdx}));
                    const nextQuestion = quizState.q[nextIdx];
                    if(nextQuestion.type === 'listen_find') {
                        setTimeout(() => playAudio(nextQuestion.target.word, true), 800);
                    }
                } else {
                    setQuizState(prev => ({...prev, finished: true}));
                    playAudio("Quiz Complete!", true);
                }
            };

            return (
                <div className="w-full max-w-lg px-4 pt-4 pb-32">
                    {mode === 'quiz' && (
                        <div className="fixed inset-0 z-[200] bg-white/95 flex flex-col items-center p-6 animate-pop">
                            <button onClick={()=>setMode('learn')} className="absolute top-4 left-4 text-2xl">‚úï</button>
                            {!quizState.finished ? (
                                <div className="w-full max-w-md mt-10 flex flex-col items-center">
                                    <div className="w-full bg-purple-100 h-3 rounded-full mb-6">
                                        <div className="bg-qy-text-purple h-full rounded-full transition-all" style={{width: `${(quizState.idx+1)*20}%`}}></div>
                                    </div>
                                    
                                    {/* Question Display */}
                                    <div className="mb-10 text-center">
                                        {quizState.q[quizState.idx].type === 'listen_find' ? (
                                            <>
                                                <button onClick={() => playAudio(quizState.q[quizState.idx].target.word, true)} className="w-32 h-32 bg-purple-100 rounded-full flex items-center justify-center text-5xl shadow-lg active:scale-95 animate-pulse text-qy-text-purple">
                                                    üîä
                                                </button>
                                                <p className="mt-4 font-bold text-gray-500">Listen and find the letter!</p>
                                            </>
                                        ) : (
                                            <>
                                                <div className="text-[8rem] font-black text-qy-text-purple font-rounded drop-shadow-md">
                                                    {quizState.q[quizState.idx].target.id}
                                                </div>
                                                <p className="font-bold text-gray-500">Which one says this sound?</p>
                                            </>
                                        )}
                                    </div>

                                    {/* Options */}
                                    <div className="flex gap-4 w-full justify-center">
                                        {quizState.q[quizState.idx].options.map((opt, i) => (
                                            <button 
                                                key={i} 
                                                onClick={() => handleQuizOption(opt)}
                                                className="flex-1 aspect-square max-w-[100px] rounded-2xl border-4 border-purple-100 bg-white shadow-md active:scale-95 flex flex-col items-center justify-center hover:border-purple-300"
                                            >
                                                {quizState.q[quizState.idx].type === 'listen_find' ? (
                                                    <span className="text-4xl font-black text-gray-700">{opt.id}</span>
                                                ) : (
                                                    <span className="text-4xl">üîà</span> 
                                                )}
                                            </button>
                                        ))}
                                    </div>
                                    <div className="mt-8">
                                         <Mascot mode="english" status={setMascotStatus} skinId={skinId} headId={headId} eyesId={eyesId} neckId={neckId} />
                                    </div>
                                </div>
                            ) : (
                                <div className="mt-20 flex flex-col items-center">
                                    <div className="text-8xl animate-tada">üåü</div>
                                    <h2 className="text-3xl font-bold text-qy-text-purple mt-4">Great Job!</h2>
                                    <p className="text-xl text-gray-500 mt-2">You earned {quizState.earned} coins!</p>
                                    <button onClick={startQuiz} className="mt-8 px-8 py-3 bg-qy-text-purple text-white rounded-full font-bold shadow-lg">Play Again</button>
                                </div>
                            )}
                        </div>
                    )}

                    {/* Learn Mode Grid */}
                    <div className="grid grid-cols-4 sm:grid-cols-5 gap-3">
                        {PHONICS_DATA.map(item => (
                            <button 
                                key={item.id}
                                onClick={() => { setSelectedItem(item); playPhonic(item); }}
                                className="aspect-square bg-white rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center justify-center hover:scale-105 transition-transform"
                            >
                                <span className="text-3xl font-bold text-qy-text-purple font-rounded">{item.id}</span>
                                <span className="text-xs mt-1">{item.emoji}</span>
                            </button>
                        ))}
                    </div>

                    {/* Start Quiz Button */}
                    <div className="fixed bottom-24 left-0 w-full flex justify-center pointer-events-none">
                        <button onClick={startQuiz} className="pointer-events-auto bg-qy-text-purple text-white px-8 py-3 rounded-full font-bold shadow-xl animate-bounce flex items-center gap-2">
                            <span>üéÆ</span> Start Phonics Quiz
                        </button>
                    </div>

                    {/* Detail Modal */}
                    {selectedItem && mode === 'learn' && (
                        <div className="fixed inset-0 z-[150] bg-white/90 backdrop-blur-md flex flex-col items-center justify-center p-6 animate-pop">
                            <button onClick={()=>setSelectedItem(null)} className="absolute top-4 right-4 bg-gray-100 rounded-full p-2">‚úï</button>
                            <div className="text-[10rem] font-black text-qy-text-purple font-rounded leading-none">{selectedItem.id}</div>
                            <div className="text-6xl my-4 animate-bounce">{selectedItem.emoji}</div>
                            <h2 className="text-4xl font-bold text-gray-700">{selectedItem.word}</h2>
                            <div className="mt-8 flex gap-4">
                                <button onClick={() => playPhonic(selectedItem)} className="px-6 py-3 bg-purple-100 text-purple-700 rounded-full font-bold">üîä Listen</button>
                            </div>
                            <div className="mt-8 w-full max-w-sm">
                                {selectedItem.vocab.map((v, i) => (
                                    <div key={i} onClick={() => {playAudio(v.en, true); setTimeout(()=>playAudio(v.cn, false), 1000)}} className="bg-white border border-purple-100 p-3 rounded-xl mb-2 flex justify-between items-center shadow-sm cursor-pointer hover:bg-purple-50">
                                        <span className="font-bold text-lg">{v.en}</span>
                                        <span className="text-gray-400 text-sm">{v.cn}</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const HanziView = ({ setMascotStatus, addPoints, skinId, headId, eyesId, neckId, mascotStatus }) => {
            const [charData, setCharData] = useState(null);
            const [showPinyinSelector, setShowPinyinSelector] = useState(false);
            const [showQuiz, setShowQuiz] = useState(false);
            const [mode, setMode] = useState('quiz');

            // Initial load
            useEffect(() => { handleSearch('‰πî'); }, []);

            const handleSearch = (char) => {
                 try {
                    const pinyins = cnchar.spell(char, 'array', 'tone').map(p=>p.toLowerCase());
                    let words = [];
                    if(cnchar.words) words = cnchar.words(char).filter(w=>w!==char).slice(0,3);
                    setCharData({ char, pinyins, id: Date.now(), words });
                    playAudio(char, false);
                 } catch(e) { console.error(e); }
            };

            return (
                <div className="w-full max-w-lg px-4 flex flex-col items-center pt-4 pb-32">
                    {showPinyinSelector && <PinyinSelector onClose={()=>setShowPinyinSelector(false)} onSelectChar={(c)=>{setShowPinyinSelector(false); handleSearch(c);}} />}
                    {showQuiz && <HanziQuiz onClose={()=>setShowQuiz(false)} setMascotStatus={setMascotStatus} addPoints={addPoints} />}
                    
                    <div className="w-full flex items-center gap-2 mb-4">
                        <button onClick={()=>setShowPinyinSelector(true)} className="h-12 w-16 bg-qy-pink text-white rounded-xl shadow-md font-bold text-xl flex items-center justify-center">üîç</button>
                        <div className="flex-1 flex gap-2 overflow-x-auto no-scrollbar">
                            {charData?.pinyins.map(p=><button key={p} onClick={()=>playAudio(charData.char)} className="h-12 px-4 bg-white border-2 border-pink-100 rounded-xl font-bold text-lg whitespace-nowrap">{p}</button>)}
                        </div>
                        <button onClick={()=>setShowQuiz(true)} className="h-12 px-4 bg-white text-qy-text-purple border-2 border-purple-200 rounded-xl font-bold shadow-sm flex items-center gap-1">üéÆ <span className="hidden sm:inline">ÊµãËØï</span></button>
                    </div>

                    {charData && (
                        <div className="flex flex-col items-center animate-pop w-full">
                            <div className="relative mb-6">
                                <HanziPlayer key={charData.id+mode} char={charData.char} mode={mode} onMistake={()=>{}} onCorrect={()=>{}} onComplete={()=>{setMascotStatus('success'); playAudio("Â•ΩÊ£í", false);}} />
                            </div>
                            <div className="flex items-end justify-center w-full max-w-sm mb-6 gap-2">
                                <div className="flex-1 flex gap-2">
                                    <button onClick={()=>setMode('animate')} className={`flex-1 py-3 rounded-xl font-bold ${mode==='animate'?'bg-qy-pink text-white':'bg-white text-gray-500'}`}>üëÄ ÊºîÁ§∫</button>
                                    <button onClick={()=>setMode('quiz')} className={`flex-1 py-3 rounded-xl font-bold ${mode==='quiz'?'bg-qy-text-pink text-white':'bg-white text-gray-500'}`}>‚úçÔ∏è ÁªÉ‰π†</button>
                                </div>
                                <div className="shrink-0 pb-1 pl-1">
                                     <Mascot mode="hanzi" status={mascotStatus} skinId={skinId} headId={headId} eyesId={eyesId} neckId={neckId} />
                                </div>
                            </div>
                            <div className="w-full bg-white p-4 rounded-2xl shadow-sm border border-pink-100">
                                <p className="text-xs text-pink-400 font-bold mb-2">Â∏∏Áî®ËØçÁªÑ</p>
                                <div className="flex flex-wrap gap-2">
                                    {charData.words.length>0 ? charData.words.map(w=><button key={w} onClick={()=>playAudio(w)} className="px-3 py-1 bg-pink-50 text-pink-600 rounded-lg font-bold">{w}</button>) : <span className="text-gray-400 text-sm">ÊöÇÊó†</span>}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const PinyinSelector = ({ onClose, onSelectChar }) => {
            const [step, setStep] = useState('initial');
            const [selInit, setSelInit] = useState('');
            const [selFinal, setSelFinal] = useState('');
            const [matches, setMatches] = useState([]);

            const handleFinal = (f) => {
                setSelFinal(f);
                const py = (selInit==='Êó†'?'':selInit) + f.replace('v','√º');
                // Simple simplified search logic for demo
                const found = COMMON_CHARS.split('').filter(c => {
                    const pys = cnchar.spell(c, 'array', 'tone');
                    return pys.some(p => p.toLowerCase().startsWith(py));
                });
                setMatches(found.slice(0, 15)); // Limit results
                setStep('select');
            };

            return (
                <div className="fixed inset-0 z-[300] bg-white/95 flex flex-col items-center p-4 animate-pop">
                    <div className="w-full flex justify-between mb-4">
                        <button onClick={step==='initial'?onClose:()=>setStep(step==='final'?'initial':'final')} className="text-2xl font-bold text-gray-400">üîô</button>
                        <h2 className="text-xl font-bold text-qy-text-pink">ÊãºÈü≥Êü•Â≠ó</h2>
                        <div className="w-8"></div>
                    </div>
                    {step === 'initial' && (
                        <div className="grid grid-cols-4 gap-4 overflow-y-auto pb-20">
                            {PINYIN_INITIALS.map(i => <button key={i} onClick={()=>{setSelInit(i); setStep('final')}} className="p-4 bg-white border-2 border-pink-100 rounded-xl text-xl font-bold shadow-sm">{i}</button>)}
                        </div>
                    )}
                    {step === 'final' && (
                        <div className="grid grid-cols-4 gap-4 overflow-y-auto pb-20">
                            {PINYIN_FINALS.map(f => <button key={f} onClick={()=>handleFinal(f)} className="p-4 bg-white border-2 border-pink-100 rounded-xl text-xl font-bold shadow-sm">{f.replace('v','√º')}</button>)}
                        </div>
                    )}
                    {step === 'select' && (
                        <div className="grid grid-cols-5 gap-3">
                            {matches.map(c => <button key={c} onClick={()=>onSelectChar(c)} className="p-2 bg-white border border-pink-100 rounded-xl text-2xl font-chinese shadow-sm">{c}</button>)}
                        </div>
                    )}
                </div>
            );
        }

        const App = () => {
            const [mode, setMode] = useState('hanzi');
            const [points, setPoints] = useState(() => parseInt(localStorage.getItem('points') || '0'));
            const [inventory, setInventory] = useState(() => JSON.parse(localStorage.getItem('inventory') || '["default"]'));
            const [equipped, setEquipped] = useState({ 
                skin: localStorage.getItem('equippedSkin') || 'default',
                head: localStorage.getItem('equippedHead'),
                eyes: localStorage.getItem('equippedEyes'),
                neck: localStorage.getItem('equippedNeck')
            });
            const [mascotStatus, setMascotStatus] = useState('idle');
            const [showShop, setShowShop] = useState(false);

            useEffect(() => {
                localStorage.setItem('points', points);
                localStorage.setItem('inventory', JSON.stringify(inventory));
                localStorage.setItem('equippedSkin', equipped.skin);
                if(equipped.head) localStorage.setItem('equippedHead', equipped.head); else localStorage.removeItem('equippedHead');
                if(equipped.eyes) localStorage.setItem('equippedEyes', equipped.eyes); else localStorage.removeItem('equippedEyes');
                if(equipped.neck) localStorage.setItem('equippedNeck', equipped.neck); else localStorage.removeItem('equippedNeck');
                document.body.className = mode === 'hanzi' ? 'bg-pattern-hanzi' : 'bg-pattern-english';
            }, [points, inventory, equipped, mode]);

            const equipItem = (item) => {
                setEquipped(prev => {
                    if (item.category === 'skin') return { ...prev, skin: item.id };
                    if (item.unequip) return { ...prev, [item.slot]: null };
                    return { ...prev, [item.slot]: item.id };
                });
            };

            return (
                <div className="min-h-screen flex flex-col items-center">
                    <div className={`w-full py-3 px-4 flex justify-between items-center shadow-sm sticky top-0 z-40 ${mode==='hanzi'?'bg-qy-pink':'bg-qy-purple'} text-white`}>
                        <div className="flex items-center gap-2"><span className="text-xl">{mode==='hanzi'?<ChineseKnotIcon/>:'ü¶Ñ'}</span><h1 className="font-chinese font-bold tracking-widest">{mode==='hanzi'?'Ê±âÂ≠ó‰πêÂõ≠':'English Park'}</h1></div>
                        <div className="flex gap-2">
                            <button onClick={()=>setShowShop(true)} className="px-3 py-1 bg-yellow-400 text-yellow-900 rounded-full font-bold shadow-sm flex items-center gap-1">ü™ô {points}</button>
                            <button onClick={()=>setMode(m=>m==='hanzi'?'english':'hanzi')} className="px-3 py-1 bg-white/20 rounded-full font-bold text-xs border border-white/40">Switch</button>
                        </div>
                    </div>

                    <div className="w-full flex justify-center">
                        {mode === 'hanzi' ? 
                            <HanziView setMascotStatus={setMascotStatus} addPoints={(n)=>setPoints(p=>p+n)} skinId={equipped.skin} headId={equipped.head} eyesId={equipped.eyes} neckId={equipped.neck} mascotStatus={mascotStatus} /> : 
                            <EnglishView setMascotStatus={setMascotStatus} addPoints={(n)=>setPoints(p=>p+n)} skinId={equipped.skin} headId={equipped.head} eyesId={equipped.eyes} neckId={equipped.neck} />
                        }
                    </div>

                    {showShop && <ShopModal onClose={()=>setShowShop(false)} inventory={inventory} equippedSkin={equipped.skin} equippedHead={equipped.head} equippedEyes={equipped.eyes} equippedNeck={equipped.neck} balance={points} onBuy={(item)=>{if(points>=item.price){setPoints(p=>p-item.price); setInventory(i=>[...i,item.id])}}} onEquip={equipItem} onAddPoints={(n)=>setPoints(p=>p+n)} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

        // Register SW
        if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
    </script>
</body>
</html>